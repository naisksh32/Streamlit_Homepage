# Guardian Agent: ìœ„í—˜ ìƒí™© ê°œì… ë° êµìœ¡
# ê°œì¸ì •ë³´ ë…¸ì¶œ ì‹œ ëŒ€í™”ë¥¼ ì¤‘ë‹¨í•˜ê³  êµìœ¡ ë©”ì‹œì§€ ì œê³µ
#
# ============================================================================
# TODO: ë‹¤ë¥¸ ë‹´ë‹¹ìê°€ êµ¬í˜„í•  ë¶€ë¶„
# ============================================================================
# 
# êµ¬í˜„ ìš”êµ¬ì‚¬í•­:
# 1. ë¡¤í”Œë ˆì‰ ëŒ€í™”ë¥¼ ì¤‘ë‹¨í•˜ê³  ìœ„í—˜ ìƒí™© ì„¤ëª…
# 2. RAGë¡œ ë§¤ì¼ê²½ì œ ë‰´ìŠ¤ ë°ì´í„°ë¥¼ ê²€ìƒ‰í•˜ì—¬ ì‚¬ì‹¤ ê¸°ë°˜ ê²½ê³  ìƒì„±
# 3. ì™œ ìœ„í—˜í•œì§€ ì´ìœ ë¥¼ ì„¤ëª…í•˜ê³  ëŒ€ì²˜ ë°©ë²• ì œì‹œ
# 4. "ë‹¤ë¥¸ ìƒí™©ë„ ì—°ìŠµí•´ë³¼ê¹Œìš”?" ë“±ì˜ ë¬¸êµ¬ë¡œ ì§€ì† í•™ìŠµ ìœ ë„
#
# ì°¸ê³ í•  í•¨ìˆ˜:
# - search_voice_phishing_cases(query, top_k): RAG ê²€ìƒ‰
# - format_rag_result_for_llm(results): ê²€ìƒ‰ ê²°ê³¼ í¬ë§·íŒ…
#
# ì¶œë ¥ ì˜ˆì‹œ:
# "ì ê¹ìš”! ë°©ê¸ˆ ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸ë¥¼ ë§ì”€í•˜ì…¨ëŠ”ë°, ì´ê±´ ë§¤ìš° ìœ„í—˜í•©ë‹ˆë‹¤.
#  ì‹¤ì œë¡œ ë§¤ì¼ê²½ì œ ê¸°ì‚¬ì— ë”°ë¥´ë©´, ì¹´ë“œì‚¬ ì‚¬ì¹­ ì‚¬ê¸°ë²”ë“¤ì´ ì´ëŸ° ë°©ì‹ìœ¼ë¡œ
#  ê°œì¸ì •ë³´ë¥¼ ìˆ˜ì§‘í•œ ë’¤ ê¸ˆìœµ í”¼í•´ë¥¼ ì¼ìœ¼í‚¨ ì‚¬ë¡€ê°€ ìˆìŠµë‹ˆë‹¤.
#  
#  ì•ìœ¼ë¡œëŠ” ì „í™”ë¡œ ì ˆëŒ€ ê°œì¸ì •ë³´ë¥¼ ì•Œë ¤ì£¼ì§€ ë§ˆì„¸ìš”.
#  ë‹¤ë¥¸ ìƒí™©ë„ ì—°ìŠµí•´ë³¼ê¹Œìš”?"
# ============================================================================

from langchain_core.messages import AIMessage

from ..graph.state import VoiceGuardianState
from ..tools.voice_phishing_rag import search_voice_phishing_cases, format_rag_result_for_llm


def guardian_node(state: VoiceGuardianState) -> dict:
    """
    Guardian Agent ë…¸ë“œ (ìŠ¤ì¼ˆë ˆí†¤)
    
    ìœ„í—˜ ìƒí™© ë°œìƒ ì‹œ ê°œì…í•˜ì—¬ êµìœ¡ ë©”ì‹œì§€ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
    
    Args:
        state: í˜„ì¬ ê³µìœ  ìƒíƒœ
        
    Returns:
        ì—…ë°ì´íŠ¸í•  ìƒíƒœ ë”•ì…”ë„ˆë¦¬ (messagesì— êµìœ¡ ë©”ì‹œì§€ ì¶”ê°€)
        
    TODO: ì‹¤ì œ êµìœ¡ ë©”ì‹œì§€ ìƒì„± ë¡œì§ êµ¬í˜„ í•„ìš”
    - RAGë¡œ ê´€ë ¨ ë‰´ìŠ¤ ê²€ìƒ‰
    - LLMìœ¼ë¡œ ìƒí™©ë³„ ë§ì¶¤ ê²½ê³  ë©”ì‹œì§€ ìƒì„±
    - ëŒ€ì²˜ ë°©ë²• ë° ì¬í•™ìŠµ ìœ ë„ ë¬¸êµ¬ í¬í•¨
    """
    evaluation_result = state.get("evaluation_result", {})
    scenario_topic = state.get("scenario_topic", "")
    
    # ê°ì§€ëœ ìœ„í—˜ ì •ë³´
    reason = evaluation_result.get("reason", "ê°œì¸ì •ë³´ ë…¸ì¶œ ìœ„í—˜")
    detected_info = evaluation_result.get("detected_info", [])
    
    # ========================================
    # TODO: ì—¬ê¸°ì— ì‹¤ì œ êµìœ¡ ë©”ì‹œì§€ ìƒì„± ë¡œì§ êµ¬í˜„
    # ========================================
    #
    # ì˜ˆì‹œ êµ¬í˜„ íë¦„:
    # 1. news_results = search_voice_phishing_cases(scenario_topic)
    # 2. news_context = format_rag_result_for_llm(news_results)
    # 3. education_message = generate_education_message(
    #        reason=reason,
    #        detected_info=detected_info,
    #        news_context=news_context
    #    )
    #
    # ========================================
    
    # ì„ì‹œ êµ¬í˜„: ê¸°ë³¸ ê²½ê³  ë©”ì‹œì§€ (ì‹¤ì œ êµ¬í˜„ ì‹œ êµì²´)
    detected_str = ", ".join(detected_info) if detected_info else "ë¯¼ê°í•œ ì •ë³´"
    
    education_message = f"""âš ï¸ ì ê¹ìš”! ìœ„í—˜í•œ ìƒí™©ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.

[ê°ì§€ëœ ìœ„í—˜]: {reason}
[ë…¸ì¶œëœ ì •ë³´]: {detected_str}

ğŸ’¡ ê¸°ì–µí•˜ì„¸ìš”:
- ì „í™”ë¡œ ê°œì¸ì •ë³´(ì£¼ë¯¼ë²ˆí˜¸, ê³„ì¢Œë²ˆí˜¸, ë¹„ë°€ë²ˆí˜¸)ë¥¼ ì ˆëŒ€ ì•Œë ¤ì£¼ì§€ ë§ˆì„¸ìš”.
- ê³µê³µê¸°ê´€ì´ë‚˜ ê¸ˆìœµê¸°ê´€ì€ ì „í™”ë¡œ ê°œì¸ì •ë³´ë¥¼ ìš”êµ¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
- ì˜ì‹¬ë˜ë©´ ì „í™”ë¥¼ ëŠê³  í•´ë‹¹ ê¸°ê´€ì— ì§ì ‘ í™•ì¸í•˜ì„¸ìš”.

[ìŠ¤ì¼ˆë ˆí†¤ ë©”ì‹œì§€] ì‹¤ì œ êµ¬í˜„ ì‹œ RAG ê¸°ë°˜ ë‰´ìŠ¤ ë°ì´í„°ë¡œ êµ¬ì²´ì ì¸ ì‚¬ë¡€ë¥¼ ì œê³µí•©ë‹ˆë‹¤.

ë‹¤ë¥¸ ìƒí™©ë„ ì—°ìŠµí•´ë³¼ê¹Œìš”?"""
    
    return {
        "messages": [AIMessage(content=education_message)],
        "current_phase": "guardian",  # Masterê°€ ë‹¤ìŒ ë‹¨ê³„ ê²°ì •
    }
